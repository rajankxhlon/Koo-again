<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Profile - Koo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #fffbe6;
      padding-bottom: 70px; /* Space for footer */
    }

    .header {
      background-color: #ffcc00;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header .back-icon {
        font-size: 22px;
        color: #000;
        cursor: pointer;
        margin-right: 15px;
    }

    .header .page-title {
        margin: 0;
        color: #000;
        font-size: 20px;
        font-weight: bold;
        flex-grow: 1;
    }

    /* Three-dot menu styles */
    .header .more-options-container {
        position: relative;
        margin-left: auto; /* Push to the right */
    }

    .header .more-options-btn {
        background: none;
        border: none;
        font-size: 22px;
        color: #000;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background-color 0.2s ease;
    }

    .header .more-options-btn:hover {
        background-color: #ffdb4d;
    }

    .header .options-menu {
        position: absolute;
        top: 40px; /* Position below the button */
        right: 0;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        z-index: 20;
        display: none; /* Hidden by default */
        min-width: 150px;
        overflow: hidden;
    }

    .header .options-menu.active {
        display: block;
    }

    .header .options-menu button {
        display: block;
        width: 100%;
        padding: 10px 15px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        font-size: 15px;
        color: #333;
        transition: background-color 0.2s ease;
    }

    .header .options-menu button:hover {
        background-color: #f0f0f0;
    }


    /* Profile Card */
    .profile-card {
      background-color: #fff;
      padding: 20px;
      margin: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      text-align: center; /* Keep this to center profile pic, username, and stats container */
      position: relative;
    }

    .profile-pic-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0 auto 15px; /* `margin: 0 auto` helps center block elements */
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid #ffcc00;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f0f0f0; /* Placeholder background */
    }

    .profile-pic {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-initial {
      font-size: 40px;
      font-weight: bold;
      color: #000;
      text-transform: uppercase;
    }

    .username {
      font-size: 22px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .profession, .bio {
        font-size: 15px;
        color: #555;
        margin-bottom: 5px;
        white-space: pre-wrap; /* Preserve line breaks */
        word-wrap: break-word;
    }
    .bio {
        margin-top: 10px;
        margin-bottom: 15px;
        color: #444;
    }

    .follow-unfollow-btn {
        background-color: #ffcc00;
        color: #000;
        border: none;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s ease;
        margin-top: 10px;
        display: block; /* Make it a block element */
        margin-left: auto; /* Push it to the right */
        margin-right: 0; /* Align to the right of its container */
    }

    .follow-unfollow-btn.following {
        background-color: #e0e0e0;
        color: #555;
    }

    .follow-unfollow-btn:hover {
        background-color: #ffdb4d;
    }

    .follow-unfollow-btn.following:hover {
        background-color: #ccc;
    }

    .stats-container {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-count {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .stat-label {
      font-size: 13px;
      color: #777;
    }

    /* User Koos Section */
    .user-koos-section {
      margin: 15px;
      padding: 0 0 15px; /* Add bottom padding */
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .user-koos-section h2 {
      font-size: 20px;
      color: #333;
      padding: 15px 20px;
      margin: 0;
      border-bottom: 1px solid #eee;
    }

    .user-koos-feed {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Koo Card Styling (reused from home.html) */
    .koo-card {
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 15px;
      border: 1px solid #eee;
      position: relative;
    }

    .koo-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      position: relative;
    }

    .koo-header .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
      border: 1px solid #ddd;
    }

    .koo-header .profile-initial {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #ffcc00;
        color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        font-weight: bold;
        margin-right: 10px;
        text-transform: uppercase;
    }

    .username-koo { /* Different class to avoid conflict with main username */
      font-weight: bold;
      color: #333;
      font-size: 15px;
    }

    .koo-timestamp {
        font-size: 12px;
        color: #777;
        margin-left: 8px;
    }

    .koo-text {
      font-size: 15px;
      color: #333;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-bottom: 10px;
    }

    .koo-image {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 10px;
      display: block;
      height: auto;
      object-fit: cover;
      max-height: 300px;
    }

    .koo-actions {
      display: flex;
      justify-content: space-around;
      padding-top: 10px;
      border-top: 1px solid #eee;
      margin-top: 10px;
    }

    .koo-action-btn {
      background: none;
      border: none;
      color: #777;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .koo-action-btn:hover {
      background-color: #f0f0f0;
    }

    .koo-action-btn i {
      font-size: 18px;
    }
    
    .koo-action-btn.liked {
      color: #ff0000;
    }
    .koo-action-btn.rekooed {
      color: #008000;
    }

    /* Post Options / Follow Button - removed for user profile, but kept styling if needed */
    .post-options-container {
        position: absolute;
        right: 0; /* Align to the right edge of koo-header */
        top: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .options-btn {
        background: none;
        border: none;
        font-size: 18px;
        color: #777;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background-color 0.2s ease;
    }

    .options-btn:hover {
        background-color: #f0f0f0;
    }

    .options-menu {
        position: absolute;
        top: 30px; /* Adjust based on icon size */
        right: 0;
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        z-index: 20;
        display: none; /* Hidden by default */
        min-width: 120px;
        overflow: hidden;
    }

    .options-menu.active {
        display: block;
    }

    .options-menu button {
        display: block;
        width: 100%;
        padding: 10px 15px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        color: #333;
        transition: background-color 0.2s ease;
    }

    .options-menu button:hover {
        background-color: #f0f0f0;
    }

    /* No Koos message */
    .no-koos-message {
      text-align: center;
      padding: 50px 20px;
      color: #777;
      font-size: 16px;
    }

    /* Loader */
    .loader {
        border: 4px solid #f3f3f3; /* Light grey */
        border-top: 4px solid #ffcc00; /* Yellow */
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: none; /* Hidden by default */
        position: absolute;
        top: calc(50% - 10px);
        left: calc(50% - 10px);
        z-index: 1;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Footer (reused from home.html) */
    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #fff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 60px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      z-index: 100;
    }

    .footer i {
      font-size: 22px;
      color: #000;
      cursor: pointer;
    }

  </style>
</head>
<body>

  <div class="header">
    <i class="fas fa-arrow-left back-icon" onclick="window.history.back()"></i>
    <span class="page-title" id="userProfileTitle">User Profile</span>
    <div class="more-options-container">
        <button class="more-options-btn" onclick="toggleHeaderOptions(this)"><i class="fas fa-ellipsis-v"></i></button>
        <div class="options-menu" id="headerOptionsMenu">
            <button onclick="navigateToPage('home.html')">Home</button>
            <button onclick="navigateToPage('profile.html')">My Profile</button>
            <button onclick="logout()">Logout</button>
        </div>
    </div>
  </div>

  <div class="profile-card">
    <div class="profile-pic-container" id="profilePicContainer">
      <img src="" alt="Profile Picture" class="profile-pic" id="profilePic" style="display: none;">
      <div class="profile-initial" id="profileInitial"></div>
      <div class="loader" id="profilePicLoader"></div>
    </div>
    
    <h1 class="username" id="profileUsername">Loading...</h1>
    <p class="profession" id="profileProfession" style="display: none;"></p>
    <p class="bio" id="profileBio" style="display: none;"></p>

    <button class="follow-unfollow-btn" id="followUnfollowBtn" style="display: none;">Loading...</button>

    <div class="stats-container">
      <div class="stat-item">
        <div class="stat-count" id="kooCount">0</div>
        <div class="stat-label">Koos</div>
      </div>
      <div class="stat-item">
        <div class="stat-count" id="followersCount">0</div>
        <div class="stat-label">Followers</div>
      </div>
      <div class="stat-item">
        <div class="stat-count" id="followingCount">0</div>
        <div class="stat-label">Following</div>
      </div>
    </div>
  </div>

  <div class="user-koos-section">
    <h2>User's Koos</h2>
    <div class="user-koos-feed" id="userKoosFeed">
      <div class="no-koos-message" id="loadingUserKoos">Loading user's Koos...</div>
      <div class="no-koos-message" id="noUserKoos" style="display: none;">This user hasn't posted any Koos yet!</div>
    </div>
  </div>

  <div class="footer">
    <i class="fas fa-home" title="Home" onclick="window.location.href='home.html'"></i>
    <i class="fas fa-hashtag" title="Trending" onclick="window.location.href='trending.html'"></i>
    <i class="fas fa-search" title="Search" onclick="window.location.href='search.html'"></i>
    <i class="fas fa-user-circle" title="Profile" onclick="window.location.href='profile.html'"></i>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase Config (use your actual config)
    const firebaseConfig = {
      apiKey: "AIzaSyA_VyZXGHrlJLWBFH8Q5b887y7PFHZpVks",
      authDomain: "petpal-15621.firebaseapp.com",
      projectId: "petpal-15621",
      storageBucket: "petpal-15621.firebasestorage.app",
      messagingSenderId: "251985816504",
      appId: "1:251985816504:web:ae5b859a963026c8b5bd4d",
      measurementId: "G-Z2ED9VCCZY"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM Elements
    const userProfileTitle = document.getElementById('userProfileTitle');
    const profilePic = document.getElementById('profilePic');
    const profileInitial = document.getElementById('profileInitial');
    const profileUsername = document.getElementById('profileUsername');
    const profileProfession = document.getElementById('profileProfession'); // New
    const profileBio = document.getElementById('profileBio');             // New
    const kooCountSpan = document.getElementById('kooCount');
    const followersCountSpan = document.getElementById('followersCount');
    const followingCountSpan = document.getElementById('followingCount');
    const userKoosFeed = document.getElementById('userKoosFeed');
    const loadingUserKoos = document.getElementById('loadingUserKoos');
    const noUserKoos = document.getElementById('noUserKoos');
    const followUnfollowBtn = document.getElementById('followUnfollowBtn');
    const headerOptionsMenu = document.getElementById('headerOptionsMenu');

    let currentLoggedInUserId = null;
    let targetUserId = null; // The ID of the user whose profile is being viewed

    // --- Utility Functions ---

    function formatTimestamp(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate();
      const now = new Date();
      const diff = now.getTime() - date.getTime();

      const seconds = Math.floor(diff / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (seconds < 60) return `${seconds}s ago`;
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    async function getUserProfile(userId) {
        try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
                return { id: userDoc.id, ...userDoc.data() };
            }
            return null;
        } catch (error) {
            console.error("Error fetching user profile:", error);
            return null;
        }
    }
    
    // --- Header Menu Logic ---
    function toggleHeaderOptions(button) {
        document.querySelectorAll('.options-menu.active').forEach(openMenu => {
            if (openMenu.id !== 'headerOptionsMenu') {
                openMenu.classList.remove('active');
            }
        });
        headerOptionsMenu.classList.toggle('active');
        document.addEventListener('click', function closeMenu(event) {
            if (!headerOptionsMenu.contains(event.target) && !button.contains(event.target)) {
                headerOptionsMenu.classList.remove('active');
                document.removeEventListener('click', closeMenu);
            }
        });
    }

    function logout() {
      auth.signOut().then(() => {
        alert("Logged out successfully!");
        window.location.href = "index.html"; // Redirect to login page
      }).catch((error) => {
        console.error("Error logging out:", error);
        alert("Failed to log out. Please try again.");
      });
    }

    function navigateToPage(pageUrl) {
        headerOptionsMenu.classList.remove('active'); // Close menu
        window.location.href = pageUrl;
    }

    // --- Load User Profile Data ---
    async function loadUserProfile(userId) {
      if (!userId) {
        profileUsername.textContent = "Profile Not Found";
        profileProfession.style.display = 'none';
        profileBio.style.display = 'none';
        kooCountSpan.textContent = "0";
        followersCountSpan.textContent = "0";
        followingCountSpan.textContent = "0";
        return;
      }

      try {
        const userProfile = await getUserProfile(userId);
        if (userProfile) {
          userProfileTitle.textContent = `${userProfile.displayName || userProfile.email.split('@')[0]}'s Profile`;
          profileUsername.textContent = `@${userProfile.displayName || userProfile.email.split('@')[0]}`;
          followersCountSpan.textContent = userProfile.followers ? userProfile.followers.length : 0;
          followingCountSpan.textContent = userProfile.following ? userProfile.following.length : 0;

          // Display profession
          if (userProfile.profession) {
              profileProfession.textContent = userProfile.profession;
              profileProfession.style.display = 'block';
          } else {
              profileProfession.style.display = 'none';
          }

          // Display bio
          if (userProfile.bio) {
              profileBio.textContent = userProfile.bio;
              profileBio.style.display = 'block';
          } else {
              profileBio.style.display = 'none';
          }

          // Display profile picture or initial
          if (userProfile.profilePicUrl) {
            profilePic.src = userProfile.profilePicUrl;
            profilePic.style.display = 'block';
            profileInitial.style.display = 'none';
          } else {
            profilePic.style.display = 'none';
            profileInitial.textContent = (userProfile.displayName || userProfile.email.charAt(0)).charAt(0).toUpperCase();
            profileInitial.style.display = 'flex'; // Ensure initial is centered
          }

          // Fetch Koo count
          const userKoosSnapshot = await db.collection('koos').where('userId', '==', userId).get();
          kooCountSpan.textContent = userKoosSnapshot.size;

          renderUserKoos(userKoosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

        } else {
          userProfileTitle.textContent = "User Profile Not Found";
          profileUsername.textContent = "User Not Found";
          profileProfession.style.display = 'none';
          profileBio.style.display = 'none';
          kooCountSpan.textContent = "0";
          followersCountSpan.textContent = "0";
          followingCountSpan.textContent = "0";
          profilePic.style.display = 'none';
          profileInitial.textContent = '?';
          profileInitial.style.display = 'flex';
          followUnfollowBtn.style.display = 'none'; // Hide button if user not found
        }
      } catch (error) {
        console.error("Error loading user profile:", error);
        profileUsername.textContent = "Error loading profile";
        userProfileTitle.textContent = "Error";
      } finally {
          checkFollowStatus(); // Always check follow status after loading the profile
      }
    }

    // --- Follow/Unfollow Logic ---
    async function checkFollowStatus() {
        if (!currentLoggedInUserId || !targetUserId || currentLoggedInUserId === targetUserId) {
            followUnfollowBtn.style.display = 'none'; // Hide button if viewing own profile or not logged in/no target
            return;
        }

        followUnfollowBtn.style.display = 'block'; // Show button

        try {
            const currentUserDoc = await db.collection('users').doc(currentLoggedInUserId).get();
            const currentUserData = currentUserDoc.data();
            const isFollowing = currentUserData.following && currentUserData.following.includes(targetUserId);

            if (isFollowing) {
                followUnfollowBtn.textContent = 'Following';
                followUnfollowBtn.classList.add('following');
            } else {
                followUnfollowBtn.textContent = 'Follow';
                followUnfollowBtn.classList.remove('following');
            }
        } catch (error) {
            console.error("Error checking follow status:", error);
            followUnfollowBtn.textContent = 'Error';
            followUnfollowBtn.disabled = true; // Disable button on error
        }
    }

    followUnfollowBtn.addEventListener('click', async () => {
        if (!currentLoggedInUserId) {
            alert("Please log in to follow users.");
            window.location.href = "index.html";
            return;
        }
        if (currentLoggedInUserId === targetUserId) {
            alert("You cannot follow yourself.");
            return;
        }

        followUnfollowBtn.disabled = true; // Disable button during operation
        const isFollowing = followUnfollowBtn.classList.contains('following');

        try {
            const currentUserRef = db.collection('users').doc(currentLoggedInUserId);
            const targetUserRef = db.collection('users').doc(targetUserId);

            await db.runTransaction(async (transaction) => {
                const currentUserDoc = await transaction.get(currentUserRef);
                const targetUserDoc = await transaction.get(targetUserRef);

                if (!currentUserDoc.exists || !targetUserDoc.exists) {
                    throw "User documents not found!";
                }

                let currentUserFollowing = currentUserDoc.data().following || [];
                let targetUserFollowers = targetUserDoc.data().followers || [];

                if (isFollowing) {
                    // Unfollow
                    currentUserFollowing = currentUserFollowing.filter(id => id !== targetUserId);
                    targetUserFollowers = targetUserFollowers.filter(id => id !== currentLoggedInUserId);
                } else {
                    // Follow
                    if (!currentUserFollowing.includes(targetUserId)) {
                        currentUserFollowing.push(targetUserId);
                    }
                    if (!targetUserFollowers.includes(currentLoggedInUserId)) {
                        targetUserFollowers.push(currentLoggedInUserId);
                    }
                }

                transaction.update(currentUserRef, { following: currentUserFollowing });
                transaction.update(targetUserRef, { followers: targetUserFollowers });
            });

            // Update UI after successful transaction
            await loadUserProfile(targetUserId); // Reload target user's profile to update follower count
            await checkFollowStatus(); // Update button text and class
            alert(isFollowing ? "Unfollowed!" : "Followed!");

        } catch (error) {
            console.error("Error toggling follow status:", error);
            alert("Failed to update follow status. Please try again.");
        } finally {
            followUnfollowBtn.disabled = false; // Re-enable button
        }
    });


    // --- Render User's Koos ---
    async function renderUserKoos(usersKoos) {
      userKoosFeed.innerHTML = ''; // Clear previous posts
      loadingUserKoos.style.display = 'none';
      noUserKoos.style.display = 'none';

      if (usersKoos.length === 0) {
        noUserKoos.style.display = 'block';
        return;
      }

      // Sort Koos by timestamp (latest first)
      usersKoos.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

      for (const koo of usersKoos) {
        const userProfile = await getUserProfile(koo.userId); // This is the target user's profile
        const profilePicUrl = userProfile && userProfile.profilePicUrl ? userProfile.profilePicUrl : null;
        const displayUsername = userProfile && userProfile.displayName ? userProfile.displayName : (koo.username || 'Anonymous');
        const firstLetter = displayUsername.charAt(0).toUpperCase();

        const hasLiked = koo.likes && koo.likes.includes(currentLoggedInUserId);
        const rekooCount = koo.rekoos ? koo.rekoos.length : 0;
        const likeCount = koo.likes ? koo.likes.length : 0;

        const kooCard = document.createElement('div');
        kooCard.className = 'koo-card';
        kooCard.id = `koo-${koo.id}`;

        kooCard.innerHTML = `
          <div class="koo-header">
            ${profilePicUrl ? `<img src="${profilePicUrl}" alt="Profile" class="profile-pic">` : `<div class="profile-initial">${firstLetter}</div>`}
            <span class="username-koo">${displayUsername}</span>
            <span class="koo-timestamp">${formatTimestamp(koo.timestamp)}</span>
            </div>
          <p class="koo-text">${koo.text}</p>
          ${koo.imageUrl ? `<img src="${koo.imageUrl}" alt="Koo Image" class="koo-image">` : ''}
          <div class="koo-actions">
            <button class="koo-action-btn ${hasLiked ? 'liked' : ''}" onclick="toggleLike('${koo.id}')">
              <i class="${hasLiked ? 'fas' : 'far'} fa-heart"></i> <span id="like-count-${koo.id}">${likeCount}</span>
            </button>
            <button class="koo-action-btn" onclick="openComments('${koo.id}')">
              <i class="far fa-comment"></i> Comment
            </button>
            <button class="koo-action-btn" onclick="rekooPost('${koo.id}')">
              <i class="fas fa-retweet"></i> <span id="rekoo-count-${koo.id}">${rekooCount > 0 ? rekooCount : ''}</span>
            </button>
          </div>
        `;
        userKoosFeed.appendChild(kooCard);
      }
    }
    
    // --- Post Action Functions (from home.html) ---

    async function toggleLike(kooId) {
        if (!currentLoggedInUserId) {
            alert("You must be logged in to like posts.");
            window.location.href = "index.html";
            return;
        }

        const kooRef = db.collection('koos').doc(kooId);
        try {
            const doc = await kooRef.get();
            if (!doc.exists) return;

            const kooData = doc.data();
            let likes = kooData.likes || [];
            const hasLiked = likes.includes(currentLoggedInUserId);

            if (hasLiked) {
                likes = likes.filter(uid => uid !== currentLoggedInUserId);
            } else {
                likes.push(currentLoggedInUserId);
            }

            await kooRef.update({ likes: likes });

            const likeButton = document.querySelector(`#koo-${kooId} .koo-action-btn:nth-child(1)`);
            const likeIcon = likeButton.querySelector('i');
            const likeCountSpan = document.getElementById(`like-count-${kooId}`);

            if (hasLiked) {
                likeIcon.classList.remove('fas', 'liked');
                likeIcon.classList.add('far');
            } else {
                likeIcon.classList.add('fas', 'liked');
                likeIcon.classList.remove('far');
            }
            likeCountSpan.textContent = likes.length;

        } catch (error) {
            console.error("Error toggling like:", error);
            alert("Failed to update like status. Please try again.");
        }
    }

    function openComments(kooId) {
        if (!currentLoggedInUserId) {
            alert("You must be logged in to view comments.");
            window.location.href = "index.html";
            return;
        }
        window.location.href = `comments.html?kooId=${kooId}`;
    }

    async function rekooPost(kooId) {
        if (!currentLoggedInUserId) {
            alert("You must be logged in to rekoo posts.");
            window.location.href = "index.html";
            return;
        }

        const kooRef = db.collection('koos').doc(kooId);
        try {
            const doc = await kooRef.get();
            if (!doc.exists) return;

            const kooData = doc.data();
            let rekoos = kooData.rekoos || [];
            const hasRekooed = rekoos.includes(currentLoggedInUserId);

            if (hasRekooed) {
                alert("You've already rekooed this post. To simplify, we won't un-rekoo.");
                return; 
            } else {
                rekoos.push(currentLoggedInUserId);
            }

            await kooRef.update({ rekoos: rekoos });

            const rekooButton = document.querySelector(`#koo-${kooId} .koo-action-btn:nth-child(3)`);
            const rekooCountSpan = document.getElementById(`rekoo-count-${kooId}`);

            rekooButton.classList.add('rekooed');
            rekooCountSpan.textContent = rekoos.length > 0 ? rekoos.length : '';
            alert("Koo rekooed!");

        } catch (error) {
            console.error("Error rekooing post:", error);
            alert("Failed to rekoo post. Please try again.");
        }
    }

    // --- Initialization ---
    auth.onAuthStateChanged(async user => {
      if (!user) {
        alert("You are not logged in. Redirecting...");
        window.location.href = "index.html";
      } else {
        currentLoggedInUserId = user.uid;
        const urlParams = new URLSearchParams(window.location.search);
        targetUserId = urlParams.get('userId');

        if (!targetUserId) {
            alert("No user ID specified. Redirecting to home.");
            window.location.href = "home.html";
            return;
        }

        if (targetUserId === currentLoggedInUserId) {
            // If the user is trying to view their own profile via user_profile.html,
            // redirect them to their dedicated profile page.
            window.location.href = "profile.html";
            return;
        }

        loadUserProfile(targetUserId);
        checkFollowStatus(); // Initial check for follow status
      }
    });

    // Footer Navigation
    document.querySelector('.footer .fa-home').onclick = () => window.location.href='home.html';
    document.querySelector('.footer .fa-hashtag').onclick = () => window.location.href='trending.html';
    document.querySelector('.footer .fa-search').onclick = () => window.location.href='search.html';
    document.querySelector('.footer .fa-user-circle').onclick = () => window.location.href='profile.html';
  </script>

</body>
</html>
